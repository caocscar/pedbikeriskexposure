<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>PedBike Risk Exposure</title>
    <style>
		html, body {
			height: 100%;
			padding: 0;
			margin: 0;
		}
		#map {
			height: 100%;
			width: 100%;
			border: thin solid #333;
		}
		.nicebox {
          position: absolute;
          text-align: center;
          font-family: "Roboto", "Arial", sans-serif;
          font-size: 13px;
          z-index: 5;
          box-shadow: 0 4px 6px -4px #333;
          padding: 5px 10px;
          background: linear-gradient(to bottom,rgba(29,202,255,1) 0%,rgb(192,222,237) 100%);
          border: rgb(229, 229, 229) 1px solid;
        }
		#controls1 {
          top: 10px;
          left: 110px;
          width: 120px;
          height: 20px;
        }
		#county {
          width: 120px;
          height: 20px;
        }
		#controls2 {
          top: 10px;
          left: 260px;
          width: 110px;
          height: 20px;
        }
		#riskexp {
          width: 110px;
          height: 20px;
        }
		#controls3 {
          top: 10px;
          left: 400px;
          width: 50px;
          height: 20px;
        }
		#ranking {
          width: 50px;
          height: 20px;
        }
		#controls4 {
          top: 10px;
          left: 480px;
          width: 100px;
          height: 20px;
        }
		#roadlayer {
          width: 100px;
          height: 20px;
        }
		#controls5 {
          top: 10px;
          left: 610px;
          width: 110px;
          height: 20px;
        }
		#crashlayer {
          width: 110px;
          height: 20px;
        }
	</style>
  </head>
  <body>
    <div id="controls1" class="nicebox">
      <div><select id="county">
		<option value=">0">All Counties</option>
  		<option value="=65">Ingham</option>
		<option value="=81">Kent</option>
		<option value="=161">Washtenaw</option>
		<option value="=163">Wayne</option>
	  </select></div>
    </div>
	<div id="controls2" class="nicebox">
	  <div><select id="riskexp">
		<option value="0">Hide SPAZ</option>
		<option value="2">Ped Risk</option>
  		<option value="3">Bike Risk</option>
		<option value="4">Ped Exposure</option>
  		<option value="5">Bike Exposure</option>
		</select></div>	  
    </div>
	<div id="controls3" class="nicebox">
	  <div><select id="ranking">
		<option value="99999">All</option>
  		<option value="10">10</option>
		<option value="25">25</option>
		<option value="100">100</option>
	  </select></div>
    </div>
	<div id="controls4" class="nicebox">
	  <div><select id="roadlayer">
		<option value="0">Hide Roads</option>
  		<option value="1">Ped - Roads</option>
  		<option value="2">Bike - Roads</option>
	  </select></div>	  
    </div>
	<div id="controls5" class="nicebox">
	  <div><select id="crashlayer">
		<option value="0">Hide Crashes</option>
  		<option value="1">Ped Crashes</option>
  		<option value="2">Bike Crashes</option>
	  </select></div>	  
    </div>
    <div id="map"></div>
    <script>
		// global variables
		var map;
		//var pedbike = "1XQm2mKsjmpjbQ-g9jXK01lqxuQm59BeSt2-Z_rNB";
		var pedroad = "1d4JszU1lOfgEIeb3meW_Igves9F54mXD8BoKSkXY";
		var bikeroad = "1mSGXLW5LiPI6w35BoxtvKRuABc_iDhuibDraaOKO";
		var crashes = "18lbdW3PLwmxhDRq4vtq2ren4yytKvRitLB801-v1";
		var pedbike_UP = "1-hG45XDxYXVXay6Rawwn_wdnJ0kxvxMKHB4zsu4n";
		var pedbike_NLP = "1ep3obncnepmwZmsd6bW90Gi5YsuOn_2SFnfOEe-5";
		var pedbike_SLP = "1XAXEliIqHYq_GJ2rLUtS00w4CVAU3bXTLYZ-qpOX";
		var selectBox1 = document.getElementById('county');
		var selectBox2 = document.getElementById('ranking');
		var selectBox3 = document.getElementById('riskexp');
		var selectBox4 = document.getElementById('roadlayer');
		var selectBox5 = document.getElementById('crashlayer');
		//var UP = [3,13,33,41,43,53,61,71,83,95,97,103,109,131,153]
		//var NLP = [1,7,9,11,17,19,29,31,35,39,47,51,55,57,69,73,79,85,89,101,105,107,111,113,117,119,121,123,127,129,133,135,137,141,143,165]	
		//var SLP = [145,157,151,63,139,81,67,37,155,49,87,147,5,15,45,65,93,125,99,159,77,25,75,161,163,21,27,149,23,59,91,115]		
		selectBox3.value = 2
		
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 12,
				center: {lat: 42.25, lng: -83.7},
				mapTypeId: 'roadmap', // ['roadmap','satellite','hybrid','terrain'] are the 4 basemaps			
			});
			// add fusion table layer	
			crashlayer = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: crashes},
				options: {styleId: 2,
						  templateId: 2},
			});
			pedbikelayerSLP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_SLP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			pedbikelayerNLP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_NLP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			pedbikelayerUP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_UP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			roadlayer = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: pedroad},
				options: {styleId: 2,
						  templateId: 2},
			});

			// callback function for div elements (dropdowns)
			google.maps.event.addDomListener(selectBox1, 'change', newSelection);
			google.maps.event.addDomListener(selectBox2, 'change', newSelection);
			google.maps.event.addDomListener(selectBox3, 'change', newSelection);
			google.maps.event.addDomListener(selectBox4, 'change', newSelection);
			google.maps.event.addDomListener(selectBox5, 'change', newSelection);
		}

		function newSelection () {
			var styleid  = selectBox3.value;
			if (styleid > 1) {
				pedbikelayerSLP.setMap(map)
				pedbikelayerNLP.setMap(map)
				pedbikelayerUP.setMap(map)
			}else{
				pedbikelayerSLP.setMap(null)
				pedbikelayerNLP.setMap(null)
				pedbikelayerUP.setMap(null)
			}				
			var ranking = selectBox2.value;

			var rankcol = (styleid == 2) ? "PRrank > 0 AND PRrank":
						  (styleid == 3) ? "BRrank > 0 and BRrank":
						  (styleid == 4) ? "PErank" : "BErank"

			var county = selectBox1.value;
			pedbikelayerSLP.setOptions({
				query: {select: 'geometry',
						from: pedbike_SLP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			pedbikelayerNLP.setOptions({
				query: {select: 'geometry',
						from: pedbike_NLP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			pedbikelayerUP.setOptions({
				query: {select: 'geometry',
						from: pedbike_UP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			
			var rd = selectBox4.value;
			(rd > 0) ? roadlayer.setMap(map) : roadlayer.setMap(null)
			roadlayer.setOptions({
				query: {select: 'geometry',
						from: (rd == 1) ? pedroad : bikeroad,
						where: county},
			});
			
			var crash = selectBox5.value;
			(crash > 0) ? crashlayer.setMap(map) : crashlayer.setMap(null)
			mode = (crash == 1) ? "Ped" : "Bike"
			crashlayer.setOptions({
				query: {select: 'geometry',
						from: crashes,
						where: "fips " + county + " AND " + mode + " >0"},
			});
		}

	</script>
    <script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDny-AaZwZEw5j-jUcfwiBMS2fch0dg4dI&callback=initMap">
    </script>
  </body>
</html>