<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>PedBike Risk Exposure</title>
    <style>
		html, body {
			height: 100%;
			padding: 0;
			margin: 0;
			font-family: "Roboto", "Arial", sans-serif;
		}
		#map {
			height: 100%;
			width: 100%;
			border: thin solid #333;
		}
		.nicebox {
          position: absolute;
          text-align: center;
          font-size: 13px;
          z-index: 5;
          box-shadow: 0 4px 6px -4px #333;
          padding: 5px 10px;
          background: linear-gradient(to bottom,rgba(29,202,255,1) 0%,rgb(192,222,237) 100%);
          border: rgb(229, 229, 229) 1px solid;
        }
		#controls1 {
          top: 10px;
          left: 110px;
          width: 120px;
          height: 20px;
        }
		#county {
          width: 120px;
          height: 20px;
        }
		#controls2 {
          top: 10px;
          left: 260px;
          width: 110px;
          height: 20px;
        }
		#riskexp {
          width: 110px;
          height: 20px;
        }
		#controls3 {
          top: 10px;
          left: 400px;
          width: 50px;
          height: 20px;
        }
		#ranking {
          width: 50px;
          height: 20px;
        }
		#controls4 {
          top: 10px;
          left: 480px;
          width: 100px;
          height: 20px;
        }
		#roadlayer {
          width: 100px;
          height: 20px;
        }
		#controls5 {
          top: 10px;
          left: 610px;
          width: 110px;
          height: 20px;
        }
		#crashlayer {
          width: 110px;
          height: 20px;
        }
		#legendwrapper{
			position: absolute;
			right: 50px;
			bottom: 20px;
			background-color: white;
			z-index: 10;
			padding:5px;
			-webkit-box-shadow: 4px 4px 11px 2px rgba(0,0,0,0.5);
			-moz-box-shadow: 4px 4px 11px 2px rgba(0,0,0,0.5);
			box-shadow: 4px 4px 11px 2px rgba(0,0,0,0.5);

		}
		.mapLegend{
			padding:5px;
			width: 150px;
			height: 150px;
			display: inline-block;
			border:#666 solid 1px;
		}

		#spazLegend rect{
			fill-opacity: 0.5;
			stroke:#666;
		}
		#roadLegend line{
			stroke-width: 5px;
			stroke-opacity: 0.8;
		}
		.legendTitle{
			font-weight: 700;
			font-size: 15px;
		}

		#roadLegend .legendCells{
			transform: translate(0, 26px);
		}

	</style>
  </head>
  <body>
    <div id="controls1" class="nicebox">
      <div><select id="county">
		<option value="0">Michigan</option>
		<option value='1'>Alcona</option>
		<option value='3'>Alger</option>
		<option value='5'>Allegan</option>
		<option value='7'>Alpena</option>
		<option value='9'>Antrim</option>
		<option value='11'>Arenac</option>
		<option value='13'>Baraga</option>
		<option value='15'>Barry</option>
		<option value='17'>Bay</option>
		<option value='19'>Benzie</option>
		<option value='21'>Berrien</option>
		<option value='23'>Branch</option>
		<option value='25'>Calhoun</option>
		<option value='27'>Cass</option>
		<option value='29'>Charlevoix</option>
		<option value='31'>Cheboygan</option>
		<option value='33'>Chippewa</option>
		<option value='35'>Clare</option>
		<option value='37'>Clinton</option>
		<option value='39'>Crawford</option>
		<option value='41'>Delta</option>
		<option value='43'>Dickinson</option>
		<option value='45'>Eaton</option>
		<option value='47'>Emmet</option>
		<option value='49'>Genesee</option>
		<option value='51'>Gladwin</option>
		<option value='53'>Gogebic</option>
		<option value='55'>Grand Traverse</option>
		<option value='57'>Gratiot</option>
		<option value='59'>Hillsdale</option>
		<option value='61'>Houghton</option>
		<option value='63'>Huron</option>
		<option value='65'>Ingham</option>
		<option value='67'>Ionia</option>
		<option value='69'>Iosco</option>
		<option value='71'>Iron</option>
		<option value='73'>Isabella</option>
		<option value='75'>Jackson</option>
		<option value='77'>Kalamazoo</option>
		<option value='79'>Kalkaska</option>
		<option value='81'>Kent</option>
		<option value='83'>Keweenaw</option>
		<option value='85'>Lake</option>
		<option value='87'>Lapeer</option>
		<option value='89'>Leelanau</option>
		<option value='91'>Lenawee</option>
		<option value='93'>Livingston</option>
		<option value='95'>Luce</option>
		<option value='97'>Mackinac</option>
		<option value='99'>Macomb</option>
		<option value='101'>Manistee</option>
		<option value='103'>Marquette</option>
		<option value='105'>Mason</option>
		<option value='107'>Mecosta</option>
		<option value='109'>Menominee</option>
		<option value='111'>Midland</option>
		<option value='113'>Missaukee</option>
		<option value='115'>Monroe</option>
		<option value='117'>Montcalm</option>
		<option value='119'>Montmorency</option>
		<option value='121'>Muskegon</option>
		<option value='123'>Newaygo</option>
		<option value='125'>Oakland</option>
		<option value='127'>Oceana</option>
		<option value='129'>Ogemaw</option>
		<option value='131'>Ontonagon</option>
		<option value='133'>Osceola</option>
		<option value='135'>Oscoda</option>
		<option value='137'>Otsego</option>
		<option value='139'>Ottawa</option>
		<option value='141'>Presque Isle</option>
		<option value='143'>Roscommon</option>
		<option value='145'>Saginaw</option>
		<option value='147'>St. Clair</option>
		<option value='149'>St. Joseph</option>
		<option value='151'>Sanilac</option>
		<option value='153'>Schoolcraft</option>
		<option value='155'>Shiawassee</option>
		<option value='157'>Tuscola</option>
		<option value='159'>Van Buren</option>
		<option value='161'>Washtenaw</option>
		<option value='163'>Wayne</option>
		<option value='165'>Wexford</option>
	  </select></div>
    </div>
	<div id="controls2" class="nicebox">
	  <div><select id="riskexp">
		<option value="0">Hide SPAZ</option>
		<option value="2">Ped Risk</option>
  		<option value="3">Bike Risk</option>
		<option value="4">Ped Exposure</option>
  		<option value="5">Bike Exposure</option>
		</select></div>	  
    </div>
	<div id="controls3" class="nicebox">
	  <div><select id="ranking">
		<option value="99999">All</option>
  		<option value="10">10</option>
		<option value="25">25</option>
		<option value="100">100</option>
	  </select></div>
    </div>
	<div id="controls4" class="nicebox">
	  <div><select id="roadlayer">
		<option value="0">Hide Roads</option>
  		<option value="1">Ped - Roads</option>
  		<option value="2">Bike - Roads</option>
	  </select></div>	  
    </div>
	<div id="controls5" class="nicebox">
	  <div><select id="crashlayer">
		<option value="0">Hide Crashes</option>
  		<option value="1">Ped Crashes</option>
  		<option value="2">Bike Crashes</option>
	  </select></div>	  
    </div>
	<div id="legendwrapper">
		<div id="spazLegend" class="mapLegend"></div>
		<div id="roadLegend" class="mapLegend"></div>
	</div>

	<div id="map"></div>
	<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.3/d3-legend.min.js"></script>
    <script>
		// global variables
		var map;
        var spazLegend = $('#spazLegend');
        var roadLegend = $('#roadLegend');
		// 10 fusion tables
		var crashes = "18lbdW3PLwmxhDRq4vtq2ren4yytKvRitLB801-v1";
		var pedbike_UP = "1-hG45XDxYXVXay6Rawwn_wdnJ0kxvxMKHB4zsu4n";
		var pedbike_NLP = "1ep3obncnepmwZmsd6bW90Gi5YsuOn_2SFnfOEe-5";
		var pedbike_SLP = "1XAXEliIqHYq_GJ2rLUtS00w4CVAU3bXTLYZ-qpOX";
		var pedroad_UP = "14eKQojT991dai5TvIvJzAvu6AKDLoKI7VNF7S_A7"
		var pedroad_North = "1BJKaPQQbg7XvM4KYu9RmbzWcvw3eaFfec7BSgby_"
		var pedroad_South = "1nqaUzvbB45QTq1cj6KNQrKSUmSiZ6_GANl76H9JE"
		var bikeroad_UP = "19U2mXFwBjrkkECtAfp1f3CGVhD1cmfKi_Z90eJpZ"
		var bikeroad_North = "11WyCtfELo_D6cuLUi-UemJIcff-96FFCaqSnOtVQ"
		var bikeroad_South = "1SL9-b8xpaLirz_wNHifOdSF0HC8C8uED9LepGOmO"
		
		var selectBox1 = document.getElementById('county');
		var selectBox2 = document.getElementById('ranking');
		var selectBox3 = document.getElementById('riskexp');
		var selectBox4 = document.getElementById('roadlayer');
		var selectBox5 = document.getElementById('crashlayer');
		selectBox3.value = 2;
		selectBox4.value = 0;
		var styleid = selectBox3.value;
		var rd = selectBox4.value;


        var PRbins = [0.5, 1, 5, 10];
        var PRcolours = ['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'];

        var PEbins = [2, 20, 60, 234];
        var PEcolours = ['#edf8fb','#b2e2e2','#66c2a4','#2ca25f','#006d2c'];

        var BRbins = [0.5, 1, 5, 10];
        var BRcolours = ['#ffffd4','#fed98e','#fe9929','#d95f0e','#993404'];

        var BEbins = [0.5, 6, 20, 84];
        var BEcolours = ['#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'];

        var pedbins = [14, 52, 87, 490];
        var pedcols = ['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'];

        var bikebins = [7, 36, 66, 400];
        var bikecols = ['#eff3ff','#bdd7e7','#6baed6','#3182bd','#08519c'];


        function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 12,
				center: {lat: 42.25, lng: -83.7},
				mapTypeId: 'roadmap', // ['roadmap','satellite','hybrid','terrain'] are the 4 basemaps			
			});
			// add fusion table layer	
			crashlayer = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: crashes},
				options: {styleId: 2,
						  templateId: 2},

			});
			pedbikelayerSLP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_SLP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			pedbikelayerNLP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_NLP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			pedbikelayerUP = new google.maps.FusionTablesLayer({
				map: map,
				query: {select: 'geometry',
						from: pedbike_UP,
						where: "PRrank > 0"},
				options: {styleId: 2,
						  templateId: 2},
			});
			roadlayerSouth = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: pedroad_South},
				options: {styleId: 2,
						  templateId: 2},
			});
			roadlayerNorth = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: pedroad_North},
				options: {styleId: 2,
						  templateId: 2},
			});
			roadlayerUP = new google.maps.FusionTablesLayer({
				query: {select: 'geometry',
						from: pedroad_UP},
				options: {styleId: 2,
						  templateId: 2},
			});
//			init legend
			drawLegend(styleid,rd);

			// callback function for div elements (dropdowns)
			google.maps.event.addDomListener(selectBox1, 'change', newSelection);
			google.maps.event.addDomListener(selectBox2, 'change', newSelection);
			google.maps.event.addDomListener(selectBox3, 'change', newSelection);
			google.maps.event.addDomListener(selectBox4, 'change', newSelection);
			google.maps.event.addDomListener(selectBox5, 'change', newSelection);
		}

		function newSelection () {
			styleid  = selectBox3.value;
			if (styleid > 1) {
				pedbikelayerSLP.setMap(map)
				pedbikelayerNLP.setMap(map)
				pedbikelayerUP.setMap(map)
			}else{
				pedbikelayerSLP.setMap(null)
				pedbikelayerNLP.setMap(null)
				pedbikelayerUP.setMap(null)
			}				
			var ranking = selectBox2.value;

			var rankcol = (styleid == 2) ? "PRrank > 0 AND PRrank":
						  (styleid == 3) ? "BRrank > 0 and BRrank":
						  (styleid == 4) ? "PErank" : "BErank"

			var county = selectBox1.value;
			county = (county == 0) ? ">"+county : "="+county
			pedbikelayerSLP.setOptions({
				query: {select: 'geometry',
						from: pedbike_SLP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			pedbikelayerNLP.setOptions({
				query: {select: 'geometry',
						from: pedbike_NLP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			pedbikelayerUP.setOptions({
				query: {select: 'geometry',
						from: pedbike_UP,
						where: "fips" + county + " AND " + rankcol + " <= " + ranking},
				styleId: styleid,
				templateId: 2,
			});
			
			rd = selectBox4.value;
			if (rd > 0) {
				roadlayerSouth.setMap(map)
				roadlayerNorth.setMap(map)
				roadlayerUP.setMap(map)
			}else{
				roadlayerSouth.setMap(null)
				roadlayerNorth.setMap(null)
				roadlayerUP.setMap(null)
			} 
			roadlayerSouth.setOptions({
				query: {select: 'geometry',
						from: (rd == 1) ? pedroad_South : bikeroad_South,
						where: "fips " + county},
			});
			roadlayerNorth.setOptions({
				query: {select: 'geometry',
						from: (rd == 1) ? pedroad_North : bikeroad_North,
						where: "fips " + county},
			});
			roadlayerUP.setOptions({
				query: {select: 'geometry',
						from: (rd == 1) ? pedroad_UP : bikeroad_UP,
						where: "fips " + county},
			});
			
			var crash = selectBox5.value;
			(crash > 0) ? crashlayer.setMap(map) : crashlayer.setMap(null)
			mode = (crash == 1) ? "Ped" : "Bike"
			crashlayer.setOptions({
				query: {select: 'geometry',
						from: crashes,
						where: "fips " + county + " AND " + mode + " >0"},
			});
//			draw legend
            drawLegend(styleid,rd);

		}

		function drawLegend(styleid,rd){
            if (styleid == 0 && rd == 0){
				spazLegend.hide();
				roadLegend.hide();
			} else if (styleid == 0){
                spazLegend.hide();
				roadLegend.show();
				drawroadLegend(rd);
			} else if (rd == 0){
                spazLegend.show();
                roadLegend.hide();
				drawSpazLegend(styleid);
			} else {
                spazLegend.show();
                roadLegend.show();
                drawroadLegend(rd);
                drawSpazLegend(styleid);
            }
        }

        function drawSpazLegend(styleid){
            if (styleid==2){
				var colorScale = d3.scaleThreshold().domain(PRbins).range(PRcolours);
				var title = "Pedestrian Risk";
            } else if (styleid==3){
                var colorScale = d3.scaleThreshold().domain(BRbins).range(BRcolours);
                var title = "Bike Risk";
            } else if (styleid==4){
                var colorScale = d3.scaleThreshold().domain(PEbins).range(PEcolours);
                var title = "Pedestrian Exposure";
            } else if (styleid==5){
                var colorScale = d3.scaleThreshold().domain(BEbins).range(BEcolours);
                var title = "Bike Exposure";
            }
            d3.select("#spazLegend").select("svg").remove();
            var legendsvg = d3.select("#spazLegend").append("svg");
            legendsvg.append("g")
                .attr("class","dynamicLegend")
                .attr("transform", "translate(10,25)");

            var legendOptions = d3.legendColor()
                .labelFormat(d3.format(""))
                .title(title)
                .labels(generateSpazLabels)
                .shapeWidth(20)
                .scale(colorScale);
            legendsvg.select('.dynamicLegend').call(legendOptions);
		}

		function drawroadLegend(rd){
            if (rd==1){
                var colorScale = d3.scaleThreshold().domain(pedbins).range(pedcols);
				var title = "Pedestrian - Road";
            } else if (rd==2){
                var colorScale = d3.scaleThreshold().domain(bikebins).range(bikecols);
                var title = "Bike - Road";
			}
            d3.select("#roadLegend").select("svg").remove();
            var legendsvg = d3.select("#roadLegend").append("svg");
            legendsvg.append("g")
                .attr("class","dynamicLegend")
                .attr("transform", "translate(10,25)");
            var legendOptions = d3.legendColor()
                .labelFormat(d3.format(""))
                .title(title)
                .labels(generateRoadLabels)
                .shape("line")
                .shapeWidth(20)
                .scale(colorScale);
            legendsvg.select('.dynamicLegend').call(legendOptions);
		}

		function generateSpazLabels({ i, genLength, generatedLabels}){
		    if (styleid==2){
		        var max=50;
			} else if (styleid==3){
                var max = 50;
			} else if (styleid==4){
                var max = 2400;
            } else if (styleid==5){
                var max = 1100;
			}
            if (i === 0 ) {
                return generatedLabels[i]
                    .replace('NaN to', '0 to');
            } else if (i === genLength - 1) {
                return `${generatedLabels[genLength - 1]
                    .replace(' to NaN', ' to '+max)}`
            }
            return generatedLabels[i]
		}

        function generateRoadLabels({ i, genLength, generatedLabels}){
            if (rd==1){
                var max =1100;
            } else if (rd==2){
                var max=900;
            }
            if (i === 0 ) {
                return generatedLabels[i]
                    .replace('NaN to', '0 to');
            } else if (i === genLength - 1) {
                return `${generatedLabels[genLength - 1]
                    .replace(' to NaN', ' to '+max)}`
            }
            return generatedLabels[i]
        }
	</script>
    <script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDny-AaZwZEw5j-jUcfwiBMS2fch0dg4dI&callback=initMap">
    </script>
  </body>
</html>